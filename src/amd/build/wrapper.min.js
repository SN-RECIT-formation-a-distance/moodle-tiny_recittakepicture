define("tiny_recittakepicture/wrapper",["exports","editor_tiny/options"],(function(_exports,_options){function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.Editor=void 0;_exports.Editor=class{constructor(){_defineProperty(this,"COMPONENTNAME","tiny_recittakepicture"),_defineProperty(this,"stream",null),_defineProperty(this,"accessGranted",!0),_defineProperty(this,"streamOptions",{video:{width:{min:64,ideal:1920},height:{min:40,ideal:1080}}}),_defineProperty(this,"devices",[]),_defineProperty(this,"cur_devices",0),_defineProperty(this,"shotBlob",""),_defineProperty(this,"cropper",null),_defineProperty(this,"dialogue",null)}open(editor){this.editor=editor,navigator.permissions&&navigator.permissions.query({name:"camera"}).then((function(state){"prompt"==state&&(this.accessGranted=!1)}));var src=M.cfg.wwwroot+"/lib/editor/tiny/plugins/recittakepicture/js/cropper.js",that=this;if(requirejs([src],(function(app){that.cropper=app})),!this.accessGranted)return alert(M.util.get_string("grantaccess",this.COMPONENTNAME)),void navigator.mediaDevices.getUserMedia({video:!0});var content='<form id="atto_recittakepicture_dialogue" class="recittakepicture"><div class="camera" id="'+this.COMPONENTNAME+'camera"><div style="margin:auto"><button id="'+this.COMPONENTNAME+'close" class="closebtn"><i class="fa fa-times-circle"></i></button><video id="'+this.COMPONENTNAME+'video" autoplay playsinline></video><div class="livevideo-controls"><div class="video-options"><button class="btn btn-secondary"><i class="fa fa-repeat"></i></button><div class="container-circles" id="'+this.COMPONENTNAME+'startbutton"><div class="outer-circle"><div class="inner-circle"></div></div></div></div></div></div></div><canvas id="'+this.COMPONENTNAME+'canvas" style="display:none"></canvas><div class="camoutput"><div class="preview"></div><img id="'+this.COMPONENTNAME+'photo" width="'+.8*window.innerWidth+'" height="'+.8*window.innerHeight+'" alt="capture"><div class="video-controls"><button id="'+this.COMPONENTNAME+'returnbutton" class="btn btn-secondary">'+M.util.get_string("back",this.COMPONENTNAME)+'</button><button class="btn btn-primary" id="'+this.COMPONENTNAME+'submit" disabled> '+M.util.get_string("saveimage",this.COMPONENTNAME)+"</button></div></div></form>";this.dialogue=this.createPopup(content),(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))&&window.scrollTo(0,1);var camera=document.getElementById(this.COMPONENTNAME+"camera"),video=document.getElementById(this.COMPONENTNAME+"video"),canvas=document.getElementById(this.COMPONENTNAME+"canvas"),photo=document.getElementById(this.COMPONENTNAME+"photo"),closebutton=document.getElementById(this.COMPONENTNAME+"close"),startbutton=document.getElementById(this.COMPONENTNAME+"startbutton"),returnbutton=document.getElementById(this.COMPONENTNAME+"returnbutton"),submitbutton=document.getElementById(this.COMPONENTNAME+"submit"),photodata="",context=(that=this,canvas.getContext("2d"));context.fillStyle="#AAA",context.fillRect(0,0,canvas.width,canvas.height),photodata=canvas.toDataURL("image/png"),photo.setAttribute("src",photodata),this.startStream(),photo.parentElement.style.display="none",startbutton.addEventListener("click",(function(ev){if(ev.preventDefault(),"none"===camera.style.display)return camera.style.display="block",photo.parentElement.style.display="none",void(submitbutton.disabled=!0);if(camera.style.display="none",photo.parentElement.style.display="block",canvas.width=video.videoWidth,canvas.height=video.videoHeight,context.drawImage(video,0,0,video.videoWidth,video.videoHeight),"undefined"!=typeof ImageCapture){const mediaStreamTrack=video.srcObject.getVideoTracks()[0];new ImageCapture(mediaStreamTrack).grabFrame().then((function(img){that.bmpToBlob(img,(function(blob){that.shotBlob=blob}))}))}photodata=canvas.toDataURL("image/png"),that.shotBlob&&(photodata=URL.createObjectURL(that.shotBlob)),photo.setAttribute("src",photodata),that.initCropper(),submitbutton.disabled=!1}),!1),returnbutton.addEventListener("click",(function(ev){ev.preventDefault(),camera.style.display="block",photo.parentElement.style.display="none",submitbutton.disabled=!0,that.cropperEl&&that.cropperEl.destroy(),that.shotBlob=null,that.cropperEl=null})),closebutton.addEventListener("click",(function(ev){ev.preventDefault(),that.close()})),submitbutton.addEventListener("click",(function(ev){ev.preventDefault(),submitbutton.disabled=!0,submitbutton.innerHTML="<i class='fa fa-spinner fa-spin'></i>",returnbutton.disabled=!0,setTimeout((function(){var blob=that.cropperEl.getCroppedCanvas({maxHeight:2e3}).toDataURL("image/jpeg",1);blob=that._convertImage(blob),that._uploadImage(blob)}),500)}),!1),this.loadCameraDevices(),this.initChangeDevice()}createPopup(content){let modal=document.createElement("div");modal.classList.add("modal","fade","recittakepicture_popup"),modal.setAttribute("style","overflow-y: hidden;");let inner2=document.createElement("div");inner2.classList.add("modal-dialog"),inner2.classList.add("modal-xl"),modal.appendChild(inner2);let inner=document.createElement("div");inner.classList.add("modal-content"),inner2.appendChild(inner);let header=document.createElement("div");header.classList.add("modal-header"),header.innerHTML="<h2>"+M.util.get_string("pluginname","tiny_recittakepicture")+"</h2>",inner.appendChild(header);let btn=document.createElement("button");btn.classList.add("close"),btn.innerHTML='<span aria-hidden="true">&times;</span>',btn.setAttribute("data-dismiss","modal"),btn.onclick=this.destroy.bind(this),header.appendChild(btn);let body=document.createElement("div");body.classList.add("modal-body"),inner.appendChild(body),body.innerHTML=content,document.body.appendChild(modal),this.popup=modal,this.popup.classList.add("show"),this.backdrop=document.createElement("div"),this.backdrop.classList.add("modal-backdrop","fade","show"),this.backdrop.setAttribute("data-backdrop","static"),document.body.appendChild(this.backdrop)}destroy(){this.popup.classList.remove("show"),this.backdrop.classList.remove("show"),this.popup.remove(),this.backdrop.remove(),this.appReact&&this.appReact.unmount()}initCropper(){this.cropperEl&&this.cropperEl.destroy();var photo=document.getElementById(this.COMPONENTNAME+"photo");this.cropperEl=new this.cropper(photo,{aspectRatio:0,viewMode:0,preview:".preview"})}loadCameraDevices(){if("mediaDevices"in navigator&&navigator.mediaDevices.getUserMedia){var that=this;navigator.mediaDevices.enumerateDevices().then((function(devices){const videoDevices=devices.filter((device=>"videoinput"===device.kind));for(var dev of(0==videoDevices.length&&(document.querySelector(".video-options").style.display="none"),that.devices=[],videoDevices))that.devices.push(dev.deviceId)}))}else document.querySelector(".video-options").style.display="none"}initChangeDevice(){var that=this;document.querySelector(".video-options>button").addEventListener("click",(function(ev){ev.preventDefault(),that.devices.length==that.cur_devices&&(that.cur_devices=0);var dev=that.devices[that.cur_devices];that.streamOptions.video.deviceId={exact:dev},that.cur_devices++,that.startStream()})),window.addEventListener("orientationchange",(function(event){that.cropperEl&&that.initCropper()}))}startStream(){var video=document.getElementById(this.COMPONENTNAME+"video"),that=this;that.stopStream(),navigator&&navigator.mediaDevices?navigator.mediaDevices.getUserMedia(that.streamOptions).then((function(stream){video.srcObject=stream,that.stream=stream,video.play(),that.loadCameraDevices()})).catch((function(err){alert(M.util.get_string("error",this.COMPONENTNAME)+": "+err)})):(alert(M.util.get_string("error",this.COMPONENTNAME)),console.log("navigator or navigator.mediaDevices are undefined"))}stopStream(){this.stream&&this.stream.getTracks().forEach((function(t){t.stop()}))}_convertImage(dataURI){var byteString;byteString=dataURI.split(",")[0].indexOf("base64")>=0?atob(dataURI.split(",")[1]):decodeURI(dataURI.split(",")[1]);for(var mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],ia=new Uint8Array(byteString.length),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);return new Blob([ia],{type:mimeString})}getFileTransferData(){const options=(0,_options.getFilePicker)(this.editor,"media");var result={repo_id:0};result.client_id=options.client_id||0,result.env=options.env||"",result.license=options.defaultlicense||"",result.itemid=options.itemid||0,result.author=options.author||"";var attr="";for(attr in options.repositories)if("upload"===options.repositories[attr].type){result.repo_id=options.repositories[attr].id;break}for(attr in options.licenses)if("cc"===options.licenses[attr].shortname){result.license=options.licenses[attr].shortname;break}return result}_uploadImage(fileToSave){var self=this,options=this.getFileTransferData(),savepath=void 0===options.savepath?"/":options.savepath,formData=new FormData,xhr=new XMLHttpRequest;formData.append("repo_upload_file",fileToSave),formData.append("itemid",options.itemid),formData.append("repo_id",options.repo_id),formData.append("env",options.env),formData.append("sesskey",M.cfg.sesskey),formData.append("client_id",options.client_id),formData.append("savepath",savepath),xhr.onreadystatechange=function(){var result,file,newhtml;if(4===xhr.readyState&&200===xhr.status){if((result=JSON.parse(xhr.responseText))&&result.error)throw new M.core.ajaxException(result);file=result,result.event&&"fileexists"===result.event&&(file=result.newfile),newhtml='<img class="w-100" src="'+file.url+'"/>',self.editor.execCommand("mceInsertContent",!1,newhtml),self.destroy()}},xhr.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),xhr.send(formData)}close(){this.getDialogue({focusAfterHide:null}).hide(),this.stopStream(),this.cropperEl&&this.cropperEl.destroy(),this.shotBlob=null,this.cropperEl=null}bmpToBlob(img,f){const canvas=document.createElement("canvas");canvas.width=img.width,canvas.height=img.height;let ctx=canvas.getContext("bitmaprenderer");ctx?ctx.transferFromImageBitmap(img):canvas.getContext("2d").drawImage(img,0,0);var blob=canvas.toBlob(f);return canvas.remove(),blob}}}));

//# sourceMappingURL=wrapper.min.js.map