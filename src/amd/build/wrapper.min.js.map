{"version":3,"file":"wrapper.min.js","sources":["../src/wrapper.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n *\r\n * @module      tiny_recittakepicture/plugin\r\n * @copyright  2019 RECIT\r\n * @license    {@link http://www.gnu.org/licenses/gpl-3.0.html} GNU GPL v3 or later\r\n */\r\n///import {get_string as getString} from 'core/str';\r\nimport {getFilePicker} from 'editor_tiny/options';\r\n\r\nexport class Editor {\r\n\r\n\r\n       COMPONENTNAME = 'tiny_recittakepicture';\r\n       stream = null;\r\n\r\n       accessGranted = true;\r\n       streamOptions = {video: {width: {min: 64, ideal: 1920}, height: {min: 40, ideal: 1080}}};\r\n       devices = [];\r\n       cur_devices = 0;\r\n       shotBlob = '';\r\n       cropper = null;\r\n       dialogue = null;\r\n\r\n    open(editor) {\r\n        this.editor = editor;\r\n        \r\n                \r\n        if (navigator.permissions) {\r\n            navigator.permissions.query({name: \"camera\"}).then(function(state) { \r\n                if (state == 'prompt') {\r\n                    this.accessGranted = false; \r\n                }\r\n            });\r\n        }\r\n        \r\n        var src = M.cfg.wwwroot + '/lib/editor/tiny/plugins/recittakepicture/js/cropper.js';\r\n        var that = this;\r\n\r\n        /*global requirejs*/\r\n        /*eslint no-undef: [\"error\", { \"typeof\": true }] */\r\n        requirejs([src], function(app) {\r\n            that.cropper = app;\r\n        });\r\n        if (!this.accessGranted) {\r\n            alert(M.util.get_string('grantaccess', this.COMPONENTNAME));\r\n            navigator.mediaDevices.getUserMedia({video:true});\r\n            return;\r\n        }\r\n        \r\n        var content = '' +\r\n            '<form id=\"atto_recittakepicture_dialogue\" class=\"recittakepicture\">' +\r\n                '<div class=\"camera\" id=\"' + this.COMPONENTNAME + 'camera\"><div style=\"margin:auto\">' +\r\n                    '<button id=\"' + this.COMPONENTNAME + 'close\" class=\"closebtn\"><i class=\"fa fa-times-circle\"></i></button>' +\r\n                    '<video id=\"' + this.COMPONENTNAME + 'video\" autoplay playsinline></video>' +\r\n                    '<div class=\"livevideo-controls\">' + \r\n                    '<div class=\"video-options\"><button class=\"btn btn-secondary\"><i class=\"fa fa-repeat\"></i></button>' +\r\n                    '<div class=\"container-circles\" id=\"' + this.COMPONENTNAME + 'startbutton\">' + \r\n                    '<div class=\"outer-circle\"><div class=\"inner-circle\"></div></div></div></div></div>' +\r\n                '</div></div>' +\r\n                '<canvas id=\"' + this.COMPONENTNAME + 'canvas\" style=\"display:none\"></canvas>' +\r\n                '<div class=\"camoutput\">' +\r\n                    '<div class=\"preview\"></div>' +\r\n                    '<img id=\"' + this.COMPONENTNAME + 'photo\" width=\"' + (window.innerWidth * 0.8) + '\" ' +\r\n                    'height=\"' + (window.innerHeight * 0.8) + '\" alt=\"capture\">' +\r\n                    '<div class=\"video-controls\"><button id=\"' + this.COMPONENTNAME + 'returnbutton\" class=\"btn btn-secondary\">' + \r\n                    M.util.get_string('back', this.COMPONENTNAME) + '</button>' +\r\n                    '<button class=\"btn btn-primary\" id=\"' + this.COMPONENTNAME + 'submit\" disabled> ' + \r\n                    M.util.get_string('saveimage', this.COMPONENTNAME) + '</button></div>' +\r\n                '</div>' +\r\n            '</form>';\r\n        this.dialogue = this.createPopup(content);\r\n        \r\n        // Apple bug: hide Safari navbar so users can see buttons\r\n        if (navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i)) {\r\n            // iOS hides Safari address bar \r\n            window.scrollTo(0, 1);\r\n        }\r\n\r\n        var camera = document.getElementById(this.COMPONENTNAME+'camera');\r\n        var video = document.getElementById(this.COMPONENTNAME+'video');\r\n        var canvas = document.getElementById(this.COMPONENTNAME+'canvas');\r\n        var photo = document.getElementById(this.COMPONENTNAME+'photo');\r\n        var closebutton = document.getElementById(this.COMPONENTNAME+'close');\r\n        var startbutton = document.getElementById(this.COMPONENTNAME+'startbutton');\r\n        var returnbutton = document.getElementById(this.COMPONENTNAME+'returnbutton');\r\n        var submitbutton = document.getElementById(this.COMPONENTNAME+'submit');\r\n        var photodata = '';\r\n\r\n        // Generate white preview\r\n        var context = canvas.getContext('2d');\r\n        context.fillStyle = \"#AAA\";\r\n        context.fillRect(0, 0, canvas.width, canvas.height);\r\n\r\n        photodata = canvas.toDataURL('image/png');\r\n        photo.setAttribute('src', photodata);\r\n\r\n        this.startStream();\r\n        photo.parentElement.style.display = \"none\";\r\n\r\n        startbutton.addEventListener('click', function(ev) {\r\n            ev.preventDefault();\r\n            if (camera.style.display === \"none\") {\r\n                camera.style.display = \"block\";\r\n                photo.parentElement.style.display = \"none\";\r\n                submitbutton.disabled = true;\r\n                return;\r\n            } else {\r\n                camera.style.display = \"none\";\r\n                photo.parentElement.style.display = \"block\";\r\n            }\r\n            canvas.width = video.videoWidth;\r\n            canvas.height = video.videoHeight;\r\n            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);\r\n            \r\n            if (typeof ImageCapture !== 'undefined') {\r\n                const mediaStreamTrack = video.srcObject.getVideoTracks()[0];\r\n                const imageCapture = new ImageCapture(mediaStreamTrack);\r\n                imageCapture.grabFrame().then(function(img) {\r\n                    that.bmpToBlob(img, function(blob) {\r\n                        that.shotBlob = blob;\r\n                    });\r\n                });\r\n            }\r\n    \r\n            photodata = canvas.toDataURL('image/png');\r\n            if (that.shotBlob) {\r\n                photodata = URL.createObjectURL(that.shotBlob);\r\n            }\r\n            photo.setAttribute('src', photodata);\r\n\r\n            that.initCropper();\r\n            \r\n            submitbutton.disabled = false;\r\n        }, false);\r\n        \r\n        returnbutton.addEventListener('click', function(ev) {\r\n            ev.preventDefault();\r\n            camera.style.display = \"block\";\r\n            photo.parentElement.style.display = \"none\";\r\n            submitbutton.disabled = true;\r\n            if (that.cropperEl) {\r\n                that.cropperEl.destroy();\r\n            } \r\n            that.shotBlob = null;\r\n            that.cropperEl = null;\r\n        });\r\n        \r\n        closebutton.addEventListener('click', function(ev) {\r\n            ev.preventDefault();\r\n            that.close();\r\n        });\r\n\r\n        submitbutton.addEventListener('click', function(ev) {\r\n            ev.preventDefault();\r\n            \r\n            // Disable buttons as the process can be slow on old devices\r\n            submitbutton.disabled = true;\r\n            submitbutton.innerHTML = '<i class=\\'fa fa-spinner fa-spin\\'></i>';\r\n            returnbutton.disabled = true;\r\n\r\n            setTimeout(function() {\r\n                // Convert it to a blob to upload\r\n                var canvas = that.cropperEl.getCroppedCanvas({\r\n                    maxHeight: 2000\r\n                });\r\n                var blob = canvas.toDataURL('image/jpeg', 1.0);\r\n                blob = that._convertImage(blob);\r\n                \r\n                that._uploadImage(blob);\r\n            }, 500);\r\n        }, false);\r\n        this.loadCameraDevices();\r\n        this.initChangeDevice();\r\n    }\r\n    \r\n    createPopup(content) {\r\n        let modal = document.createElement('div');\r\n        modal.classList.add('modal', 'fade', 'recittakepicture_popup');\r\n        modal.setAttribute('style', 'overflow-y: hidden;');\r\n\r\n        let inner2 = document.createElement('div');\r\n        inner2.classList.add('modal-dialog');\r\n        inner2.classList.add('modal-xl');\r\n        modal.appendChild(inner2);\r\n\r\n        let inner = document.createElement('div');\r\n        inner.classList.add('modal-content');\r\n        inner2.appendChild(inner);\r\n\r\n        let header = document.createElement('div');\r\n        header.classList.add('modal-header');\r\n        header.innerHTML = \"<h2>\"+M.util.get_string('pluginname', 'tiny_recittakepicture')+\"</h2>\";\r\n        inner.appendChild(header);\r\n\r\n        let btn = document.createElement('button');\r\n        btn.classList.add('close');\r\n        btn.innerHTML = '<span aria-hidden=\"true\">&times;</span>';\r\n        btn.setAttribute('data-dismiss', 'modal');\r\n        btn.onclick = this.destroy.bind(this);\r\n        header.appendChild(btn);\r\n\r\n        let body = document.createElement('div');\r\n        body.classList.add('modal-body');\r\n        inner.appendChild(body);\r\n        body.innerHTML = content;\r\n\r\n        document.body.appendChild(modal);\r\n        this.popup = modal;\r\n\r\n        this.popup.classList.add('show');\r\n\r\n        this.backdrop = document.createElement('div');\r\n        this.backdrop.classList.add('modal-backdrop', 'fade', 'show');\r\n        this.backdrop.setAttribute('data-backdrop', 'static');\r\n        document.body.appendChild(this.backdrop);\r\n    }\r\n\r\n    destroy() {\r\n        this.popup.classList.remove('show');\r\n        this.backdrop.classList.remove('show');\r\n        this.popup.remove();\r\n        this.backdrop.remove();\r\n\r\n        if (this.appReact) {\r\n            this.appReact.unmount();\r\n        }\r\n    }\r\n\r\n\r\n    initCropper() {\r\n        if (this.cropperEl) {\r\n            this.cropperEl.destroy();\r\n        } \r\n        \r\n        var photo = document.getElementById(this.COMPONENTNAME + 'photo');\r\n\r\n        this.cropperEl = new this.cropper(photo, {\r\n        aspectRatio: 0,\r\n        viewMode: 0,\r\n        preview: '.preview'\r\n        });\r\n    }\r\n\r\n    loadCameraDevices() {\r\n        if ('mediaDevices' in navigator && navigator.mediaDevices.getUserMedia) {\r\n            var that = this;\r\n            navigator.mediaDevices.enumerateDevices().then(function(devices){\r\n                const videoDevices = devices.filter(device => device.kind === 'videoinput');\r\n                if (videoDevices.length == 0){\r\n                    document.querySelector('.video-options').style.display = 'none';\r\n                }\r\n                that.devices = [];\r\n                for (var dev of videoDevices){\r\n                    that.devices.push(dev.deviceId);\r\n                }\r\n            });\r\n        }else{\r\n            // Hide camera switch button if they have only one camera\r\n            document.querySelector('.video-options').style.display = 'none';\r\n        }\r\n    }\r\n\r\n    initChangeDevice() {\r\n        var that = this;\r\n        var btn = document.querySelector('.video-options>button');\r\n        btn.addEventListener('click', function(ev) {\r\n            ev.preventDefault();\r\n            if (that.devices.length == that.cur_devices) {\r\n                that.cur_devices = 0;\r\n            }\r\n            var dev = that.devices[that.cur_devices];\r\n            that.streamOptions.video.deviceId = {exact:dev};\r\n            that.cur_devices++;\r\n            that.startStream();\r\n        });\r\n\r\n        window.addEventListener(\"orientationchange\", function() {\r\n            if (!that.cropperEl) {\r\n                return;\r\n            }\r\n            that.initCropper();\r\n        });\r\n    }\r\n\r\n    startStream() {\r\n        // access video stream from webcam\r\n        var video = document.getElementById(this.COMPONENTNAME+'video');\r\n        var that = this;\r\n        that.stopStream();\r\n        \r\n        if(navigator && navigator.mediaDevices) {\r\n            navigator.mediaDevices.getUserMedia(that.streamOptions)\r\n            // on success, stream it in video tag\r\n            .then(function(stream) {\r\n                video.srcObject = stream;\r\n                that.stream = stream;\r\n                video.play();\r\n                that.loadCameraDevices();\r\n            })\r\n            .catch(function(err) {\r\n                alert(M.util.get_string('error', this.COMPONENTNAME)+\": \" + err);\r\n            });\r\n        }\r\n        else{\r\n            alert(M.util.get_string('error', this.COMPONENTNAME));\r\n            console.log(\"navigator or navigator.mediaDevices are undefined\");\r\n        }\r\n    }\r\n\r\n    stopStream() {\r\n        if (this.stream) {\r\n            this.stream.getTracks().forEach(function(t) { t.stop(); });\r\n        }\r\n    }\r\n\r\n    _convertImage(dataURI) {\r\n        // convert base64/URLEncoded data component to raw binary data held in a string\r\n        var byteString;\r\n        if (dataURI.split(',')[0].indexOf('base64') >= 0) {\r\n            byteString = atob(dataURI.split(',')[1]);\r\n        } else {\r\n            byteString = decodeURI(dataURI.split(',')[1]);\r\n        }\r\n        // separate out the mime component\r\n        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];\r\n\r\n        // write the bytes of the string to a typed array\r\n        var ia = new Uint8Array(byteString.length);\r\n        for (var i = 0; i < byteString.length; i++) {\r\n            ia[i] = byteString.charCodeAt(i);\r\n        }\r\n\r\n        return new Blob([ia], {type: mimeString});\r\n    }\r\n\r\n    getFileTransferData(){\r\n        const options = getFilePicker(this.editor, 'media');\r\n\r\n        var result = {};\r\n        result.repo_id = 0 || 0;\r\n        result.client_id = options.client_id || 0;\r\n        result.env = options.env || '';\r\n        result.license = options.defaultlicense || '';\r\n        result.itemid = options.itemid || 0;\r\n        result.author = options.author || '';\r\n\r\n        var attr = '';\r\n        for(attr in options.repositories){\r\n            if (options.repositories[attr].type === 'upload') {\r\n                result.repo_id = options.repositories[attr].id;\r\n                break;\r\n            }\r\n        }\r\n\r\n        for(attr in options.licenses){\r\n            if (options.licenses[attr].shortname === 'cc') { // creative commons\r\n                result.license = options.licenses[attr].shortname;\r\n                break;\r\n            }\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    _uploadImage(fileToSave) {\r\n\r\n        var self = this;\r\n\r\n        var options = this.getFileTransferData(),\r\n            savepath = (options.savepath === undefined) ? '/' : options.savepath,\r\n            formData = new FormData(),\r\n            xhr = new XMLHttpRequest();\r\n\r\n        formData.append('repo_upload_file', fileToSave);\r\n        formData.append('itemid', options.itemid);\r\n\r\n        formData.append('repo_id', options.repo_id);\r\n        formData.append('env', options.env);\r\n        formData.append('sesskey', M.cfg.sesskey);\r\n        formData.append('client_id', options.client_id);\r\n        formData.append('savepath', savepath);\r\n\r\n        // Kick off a XMLHttpRequest.\r\n        xhr.onreadystatechange = function() {\r\n            var result,\r\n                file,\r\n                newhtml;\r\n\r\n            if (xhr.readyState === 4) {\r\n                if (xhr.status === 200) {\r\n                    result = JSON.parse(xhr.responseText);\r\n                    if (result) {\r\n                        if (result.error) {\r\n                            throw new M.core.ajaxException(result);\r\n                        } \r\n                    }\r\n\r\n                    file = result;\r\n                    if (result.event && result.event === 'fileexists') {\r\n                        // A file with this name is already in use here - rename to avoid conflict.\r\n                        // Chances are, it's a different image (stored in a different folder on the user's computer).\r\n                        // If the user wants to reuse an existing image, they can copy/paste it within the editor.\r\n                        file = result.newfile;\r\n                    }\r\n\r\n                    // Replace placeholder with actual image.\r\n                    newhtml = '<img class=\"w-100\" src=\"'+file.url+'\"/>';\r\n                    self.editor.execCommand('mceInsertContent', false, newhtml);\r\n                    self.destroy();\r\n                }\r\n            } else {\r\n                    //alert(M.util.get_string('servererror', 'moodle'));\r\n            }\r\n        };\r\n\r\n        xhr.open(\"POST\", M.cfg.wwwroot + '/repository/repository_ajax.php?action=upload', true);\r\n        xhr.send(formData);\r\n    }\r\n\r\n    close() {\r\n        this.destroy();\r\n        this.stopStream();\r\n        if (this.cropperEl) {\r\n            this.cropperEl.destroy();\r\n        }\r\n        this.shotBlob = null;\r\n        this.cropperEl = null;\r\n    }\r\n    \r\n    bmpToBlob(img, f) {\r\n      const canvas = document.createElement('canvas');\r\n      // resize it to the size of our ImageBitmap\r\n      canvas.width = img.width;\r\n      canvas.height = img.height;\r\n      // try to get a bitmaprenderer context\r\n      let ctx = canvas.getContext('bitmaprenderer');\r\n      if (ctx) {\r\n        // transfer the ImageBitmap to it\r\n        ctx.transferFromImageBitmap(img);\r\n      }\r\n      else {\r\n        // in case someone supports createImageBitmap only\r\n        // twice in memory...\r\n        canvas.getContext('2d').drawImage(img,0,0);\r\n      }\r\n      // get it back as a Blob\r\n      var blob = canvas.toBlob(f);\r\n      canvas.remove();\r\n      return blob;\r\n    }\r\n}"],"names":["COMPONENTNAME","stream","accessGranted","streamOptions","video","width","min","ideal","height","devices","cur_devices","shotBlob","cropper","dialogue","open","editor","navigator","permissions","query","name","then","state","src","M","cfg","wwwroot","that","this","requirejs","app","alert","util","get_string","mediaDevices","getUserMedia","content","window","innerWidth","innerHeight","createPopup","userAgent","match","scrollTo","camera","document","getElementById","canvas","photo","closebutton","startbutton","returnbutton","submitbutton","photodata","context","getContext","fillStyle","fillRect","toDataURL","setAttribute","startStream","parentElement","style","display","addEventListener","ev","preventDefault","disabled","videoWidth","videoHeight","drawImage","ImageCapture","mediaStreamTrack","srcObject","getVideoTracks","grabFrame","img","bmpToBlob","blob","URL","createObjectURL","initCropper","cropperEl","destroy","close","innerHTML","setTimeout","getCroppedCanvas","maxHeight","_convertImage","_uploadImage","loadCameraDevices","initChangeDevice","modal","createElement","classList","add","inner2","appendChild","inner","header","btn","onclick","bind","body","popup","backdrop","remove","appReact","unmount","aspectRatio","viewMode","preview","enumerateDevices","videoDevices","filter","device","kind","dev","length","querySelector","push","deviceId","exact","stopStream","play","catch","err","console","log","getTracks","forEach","t","stop","dataURI","byteString","split","indexOf","atob","decodeURI","mimeString","ia","Uint8Array","i","charCodeAt","Blob","type","getFileTransferData","options","result","client_id","env","license","defaultlicense","itemid","author","attr","repositories","repo_id","id","licenses","shortname","fileToSave","self","savepath","undefined","formData","FormData","xhr","XMLHttpRequest","append","sesskey","onreadystatechange","file","newhtml","readyState","status","JSON","parse","responseText","error","core","ajaxException","event","newfile","url","execCommand","send","f","ctx","transferFromImageBitmap","toBlob"],"mappings":"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"}