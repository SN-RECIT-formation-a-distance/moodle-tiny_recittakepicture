{"version":3,"file":"wrapper.min.js","sources":["../src/wrapper.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *\n * @module      tiny_recittakepicture/plugin\n * @copyright  2019 RECIT\n * @license    {@link http://www.gnu.org/licenses/gpl-3.0.html} GNU GPL v3 or later\n */\n///import {get_string as getString} from 'core/str';\nimport {getFilePicker} from 'editor_tiny/options';\n\nexport class Editor {\n\n\n       COMPONENTNAME= 'tiny_recittakepicture'\n       stream= null\n\n       accessGranted= true\n       streamOptions= {video: { width: { min: 64, ideal: 1920 }, height: { min: 40, ideal: 1080 }}}\n       devices= []\n       cur_devices= 0\n       shotBlob= ''\n       cropper= null\n       dialogue = null\n\n    open(editor){\n        this.editor = editor;\n        \n                \n        if (navigator.permissions){\n            navigator.permissions.query({name: \"camera\"}).then(function(state){ \n                if (state == 'prompt') this.accessGranted = false; \n            });\n        }\n        \n        var src = M.cfg.wwwroot +'/lib/editor/tiny/plugins/recittakepicture/js/cropper.js';\n        var that = this;\n        requirejs([src], function(app) {\n            that.cropper = app;\n        });\n        if (!this.accessGranted){\n            alert(M.util.get_string('grantaccess', this.COMPONENTNAME));\n            navigator.mediaDevices.getUserMedia({video:true});\n            return;\n        }\n        \n        var content = '' +\n            '<form id=\"atto_recittakepicture_dialogue\" class=\"recittakepicture\">' +\n                '<div class=\"camera\" id=\"'+this.COMPONENTNAME+'camera\"><div style=\"margin:auto\">' +\n                    '<button id=\"'+this.COMPONENTNAME+'close\" class=\"closebtn\"><i class=\"fa fa-times-circle\"></i></button>' +\n                    '<video id=\"'+this.COMPONENTNAME+'video\" autoplay playsinline></video>' +\n                    '<div class=\"livevideo-controls\"><div class=\"video-options\"><button class=\"btn btn-secondary\"><i class=\"fa fa-repeat\"></i></button>' +\n                    '<div class=\"container-circles\" id=\"'+this.COMPONENTNAME+'startbutton\"><div class=\"outer-circle\"><div class=\"inner-circle\"></div></div></div></div></div>' +\n                '</div></div>' +\n                '<canvas id=\"'+this.COMPONENTNAME+'canvas\" style=\"display:none\"></canvas>' +\n                '<div class=\"camoutput\">' +\n                    '<div class=\"preview\"></div>' +\n                    '<img id=\"'+this.COMPONENTNAME+'photo\" width=\"'+( window.innerWidth * 0.8)+'\" height=\"'+( window.innerHeight * 0.8)+'\" alt=\"capture\">' +\n                    '<div class=\"video-controls\"><button id=\"'+this.COMPONENTNAME+'returnbutton\" class=\"btn btn-secondary\">'+M.util.get_string('back', this.COMPONENTNAME)+'</button>' +\n                    '<button class=\"btn btn-primary\" id=\"'+this.COMPONENTNAME+'submit\" disabled> '+M.util.get_string('saveimage', this.COMPONENTNAME)+'</button></div>' +\n                '</div>' +\n            '</form>';\n        this.dialogue = this.createPopup(content);\n        \n        // Apple bug: hide Safari navbar so users can see buttons\n        if (navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i)) {\n            /* iOS hides Safari address bar */\n            window.scrollTo(0, 1);\n        }\n\n        var camera = document.getElementById(this.COMPONENTNAME+'camera');\n        var video = document.getElementById(this.COMPONENTNAME+'video');\n        var canvas = document.getElementById(this.COMPONENTNAME+'canvas');\n        var photo = document.getElementById(this.COMPONENTNAME+'photo');\n        var closebutton = document.getElementById(this.COMPONENTNAME+'close');\n        var startbutton = document.getElementById(this.COMPONENTNAME+'startbutton');\n        var returnbutton = document.getElementById(this.COMPONENTNAME+'returnbutton');\n        var submitbutton = document.getElementById(this.COMPONENTNAME+'submit');\n        var photodata = '';\n        var that = this;\n\n        //Generate white preview\n        var context = canvas.getContext('2d');\n        context.fillStyle = \"#AAA\";\n        context.fillRect(0, 0, canvas.width, canvas.height);\n\n        photodata = canvas.toDataURL('image/png');\n        photo.setAttribute('src', photodata);\n\n        this.startStream();\n        photo.parentElement.style.display = \"none\";\n\n        startbutton.addEventListener('click', function(ev) {\n            ev.preventDefault();\n            if (camera.style.display === \"none\") {\n                camera.style.display = \"block\";\n                photo.parentElement.style.display = \"none\";\n                submitbutton.disabled = true;\n                return;\n            }else{\n                camera.style.display = \"none\";\n                photo.parentElement.style.display = \"block\";\n            }\n            canvas.width = video.videoWidth;\n            canvas.height = video.videoHeight;\n            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);\n            \n            if (typeof ImageCapture !== 'undefined'){\n                const mediaStreamTrack = video.srcObject.getVideoTracks()[0];\n                const imageCapture = new ImageCapture(mediaStreamTrack);\n                imageCapture.grabFrame().then(function(img){\n                    that.bmpToBlob(img, function(blob){\n                        that.shotBlob = blob;\n                    })\n                });\n            }\n    \n            photodata = canvas.toDataURL('image/png');\n            if (that.shotBlob){\n                photodata = URL.createObjectURL(that.shotBlob);\n            }\n            photo.setAttribute('src', photodata);\n\n            that.initCropper();\n            \n            submitbutton.disabled = false;\n        }, false);\n        \n        returnbutton.addEventListener('click', function(ev) {\n            ev.preventDefault();\n            camera.style.display = \"block\";\n            photo.parentElement.style.display = \"none\";\n            submitbutton.disabled = true;\n            if (that.cropperEl) that.cropperEl.destroy();\n            that.shotBlob = null;\n            that.cropperEl = null;\n        });\n        \n        closebutton.addEventListener('click', function(ev) {\n            ev.preventDefault();\n            that.close();\n        });\n\n        submitbutton.addEventListener('click', function(ev) {\n            ev.preventDefault();\n            \n            // Disable buttons as the process can be slow on old devices\n            submitbutton.disabled = true;\n            submitbutton.innerHTML = '<i class=\\'fa fa-spinner fa-spin\\'></i>';\n            returnbutton.disabled = true;\n\n            setTimeout(function(){\n                // Convert it to a blob to upload\n                var canvas = that.cropperEl.getCroppedCanvas({\n                    maxHeight: 2000\n                });\n                var blob = canvas.toDataURL('image/jpeg', 1.0);\n                blob = that._convertImage(blob);\n                \n                that._uploadImage(blob);\n            }, 500);\n        }, false);\n        this.loadCameraDevices();\n        this.initChangeDevice();\n    }\n    \n    createPopup(content) {\n        let modal = document.createElement('div');\n        modal.classList.add('modal', 'fade', 'recittakepicture_popup');\n        modal.setAttribute('style', 'overflow-y: hidden;');\n\n        let inner2 = document.createElement('div');\n        inner2.classList.add('modal-dialog');\n        inner2.classList.add('modal-xl');\n        modal.appendChild(inner2);\n\n        let inner = document.createElement('div');\n        inner.classList.add('modal-content');\n        inner2.appendChild(inner);\n\n        let header = document.createElement('div');\n        header.classList.add('modal-header');\n        header.innerHTML = \"<h2>\"+M.util.get_string('pluginname', 'tiny_recittakepicture')+\"</h2>\";\n        inner.appendChild(header);\n\n        let btn = document.createElement('button');\n        btn.classList.add('close');\n        btn.innerHTML = '<span aria-hidden=\"true\">&times;</span>';\n        btn.setAttribute('data-dismiss', 'modal');\n        btn.onclick = this.destroy.bind(this);\n        header.appendChild(btn);\n\n        let body = document.createElement('div');\n        body.classList.add('modal-body');\n        inner.appendChild(body);\n        body.innerHTML = content;\n\n        document.body.appendChild(modal);\n        this.popup = modal;\n\n        this.popup.classList.add('show');\n\n        this.backdrop = document.createElement('div');\n        this.backdrop.classList.add('modal-backdrop', 'fade', 'show');\n        this.backdrop.setAttribute('data-backdrop', 'static');\n        document.body.appendChild(this.backdrop);\n    }\n\n    destroy(){\n        this.popup.classList.remove('show');\n        this.backdrop.classList.remove('show');\n        this.popup.remove();\n        this.backdrop.remove();\n\n        if(this.appReact){\n            this.appReact.unmount();\n        }\n    }\n\n\n    initCropper(){\n        if (this.cropperEl) this.cropperEl.destroy();\n        \n        var photo = document.getElementById(this.COMPONENTNAME+'photo');\n\n        this.cropperEl = new this.cropper(photo, {\n        aspectRatio: 0,\n        viewMode: 0,\n        preview: '.preview'\n        });\n    }\n\n    loadCameraDevices(){\n        if ('mediaDevices' in navigator && navigator.mediaDevices.getUserMedia) {\n            var that = this;\n            navigator.mediaDevices.enumerateDevices().then(function(devices){\n                const videoDevices = devices.filter(device => device.kind === 'videoinput');\n                if (videoDevices.length == 0){\n                    document.querySelector('.video-options').style.display = 'none';\n                }\n                that.devices = [];\n                for (var dev of videoDevices){\n                    that.devices.push(dev.deviceId);\n                }\n            });\n        }else{\n            // Hide camera switch button if they have only one camera\n            document.querySelector('.video-options').style.display = 'none';\n        }\n    }\n\n    initChangeDevice(){\n        var that = this;\n        var btn = document.querySelector('.video-options>button');\n        btn.addEventListener('click', function(ev){\n            ev.preventDefault();\n            if (that.devices.length == that.cur_devices){\n                that.cur_devices = 0;\n            }\n            var dev = that.devices[that.cur_devices];\n            that.streamOptions.video.deviceId = {exact:dev};\n            that.cur_devices++;\n            that.startStream();\n        });\n\n        window.addEventListener(\"orientationchange\", function(event) {\n            if (!that.cropperEl) return;\n            that.initCropper();\n        });\n    }\n\n    startStream(){\n        // access video stream from webcam\n        var video = document.getElementById(this.COMPONENTNAME+'video');\n        var that = this;\n        that.stopStream();\n        \n        if(navigator && navigator.mediaDevices){\n            navigator.mediaDevices.getUserMedia(that.streamOptions)\n            // on success, stream it in video tag\n            .then(function(stream) {\n                video.srcObject = stream;\n                that.stream = stream;\n                video.play();\n                that.loadCameraDevices();\n            })\n            .catch(function(err) {\n                alert(M.util.get_string('error', this.COMPONENTNAME)+\": \" + err);\n            });\n        }\n        else{\n            alert(M.util.get_string('error', this.COMPONENTNAME));\n            console.log(\"navigator or navigator.mediaDevices are undefined\");\n        }\n    }\n\n    stopStream(){\n        if (this.stream){\n            this.stream.getTracks().forEach(function(t){ t.stop()});\n        }\n    }\n\n    _convertImage(dataURI) {\n        // convert base64/URLEncoded data component to raw binary data held in a string\n        var byteString;\n        if (dataURI.split(',')[0].indexOf('base64') >= 0) {\n            byteString = atob(dataURI.split(',')[1]);\n        } else {\n            byteString = decodeURI(dataURI.split(',')[1]);\n        }\n        // separate out the mime component\n        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];\n\n        // write the bytes of the string to a typed array\n        var ia = new Uint8Array(byteString.length);\n        for (var i = 0; i < byteString.length; i++) {\n            ia[i] = byteString.charCodeAt(i);\n        }\n\n        return new Blob([ia], {type: mimeString});\n    }\n\n    getFileTransferData(){\n        const options = getFilePicker(this.editor, 'media');\n\n        var result = {};\n        result.repo_id = 0 || 0;\n        result.client_id = options.client_id || 0;\n        result.env = options.env || '';\n        result.license = options.defaultlicense || '';\n        result.itemid = options.itemid || 0;\n        result.author = options.author || '';\n\n        var attr = '';\n        for(attr in options.repositories){\n            if (options.repositories[attr].type === 'upload') {\n                result.repo_id = options.repositories[attr].id;\n                break;\n            }\n        }\n\n        for(attr in options.licenses){\n            if (options.licenses[attr].shortname === 'cc') { // creative commons\n                result.license = options.licenses[attr].shortname;\n                break;\n            }\n        }\n\n        return result;\n    }\n\n    _uploadImage(fileToSave) {\n\n        var self = this;\n\n        var options = this.getFileTransferData(),\n            savepath = (options.savepath === undefined) ? '/' : options.savepath,\n            formData = new FormData(),\n            timestamp = 0,\n            uploadid = \"\",\n            xhr = new XMLHttpRequest();\n\n        formData.append('repo_upload_file', fileToSave);\n        formData.append('itemid', options.itemid);\n\n        formData.append('repo_id', options.repo_id);\n        formData.append('env', options.env);\n        formData.append('sesskey', M.cfg.sesskey);\n        formData.append('client_id', options.client_id);\n        formData.append('savepath', savepath);\n\n        // Kick off a XMLHttpRequest.\n        xhr.onreadystatechange = function() {\n            var result,\n                file,\n                newhtml;\n\n            if (xhr.readyState === 4) {\n                if (xhr.status === 200) {\n                    result = JSON.parse(xhr.responseText);\n                    if (result) {\n                        if (result.error) \n                            throw new M.core.ajaxException(result);\n                        }\n\n                        file = result;\n                        if (result.event && result.event === 'fileexists') {\n                            // A file with this name is already in use here - rename to avoid conflict.\n                            // Chances are, it's a different image (stored in a different folder on the user's computer).\n                            // If the user wants to reuse an existing image, they can copy/paste it within the editor.\n                            file = result.newfile;\n                        }\n\n                        // Replace placeholder with actual image.\n                        newhtml = '<img class=\"w-100\" src=\"'+file.url+'\"/>';\n                        self.editor.execCommand('mceInsertContent', false, newhtml);\n                        self.destroy();\n                    }\n                } else {\n                     //alert(M.util.get_string('servererror', 'moodle'));\n                }\n            \n        }\n\n        xhr.open(\"POST\", M.cfg.wwwroot + '/repository/repository_ajax.php?action=upload', true);\n        xhr.send(formData);\n    }\n\n    close(){\n        this.getDialogue({\n            focusAfterHide: null\n        }).hide();\n        this.stopStream();\n        if (this.cropperEl) this.cropperEl.destroy();\n        this.shotBlob = null;\n        this.cropperEl = null;\n    }\n    \n    bmpToBlob(img, f){\n      const canvas = document.createElement('canvas');\n      // resize it to the size of our ImageBitmap\n      canvas.width = img.width;\n      canvas.height = img.height;\n      // try to get a bitmaprenderer context\n      let ctx = canvas.getContext('bitmaprenderer');\n      if(ctx) {\n        // transfer the ImageBitmap to it\n        ctx.transferFromImageBitmap(img);\n      }\n      else {\n        // in case someone supports createImageBitmap only\n        // twice in memory...\n        canvas.getContext('2d').drawImage(img,0,0);\n      }\n      // get it back as a Blob\n      var blob = canvas.toBlob(f);\n      canvas.remove()\n      return blob;\n    }\n}"],"names":["video","width","min","ideal","height","open","editor","navigator","permissions","query","name","then","state","this","accessGranted","src","M","cfg","wwwroot","that","requirejs","app","cropper","alert","util","get_string","COMPONENTNAME","mediaDevices","getUserMedia","content","window","innerWidth","innerHeight","dialogue","createPopup","userAgent","match","scrollTo","camera","document","getElementById","canvas","photo","closebutton","startbutton","returnbutton","submitbutton","photodata","context","getContext","fillStyle","fillRect","toDataURL","setAttribute","startStream","parentElement","style","display","addEventListener","ev","preventDefault","disabled","videoWidth","videoHeight","drawImage","ImageCapture","mediaStreamTrack","srcObject","getVideoTracks","grabFrame","img","bmpToBlob","blob","shotBlob","URL","createObjectURL","initCropper","cropperEl","destroy","close","innerHTML","setTimeout","getCroppedCanvas","maxHeight","_convertImage","_uploadImage","loadCameraDevices","initChangeDevice","modal","createElement","classList","add","inner2","appendChild","inner","header","btn","onclick","bind","body","popup","backdrop","remove","appReact","unmount","aspectRatio","viewMode","preview","enumerateDevices","devices","videoDevices","filter","device","kind","dev","length","querySelector","push","deviceId","cur_devices","streamOptions","exact","event","stopStream","stream","play","catch","err","console","log","getTracks","forEach","t","stop","dataURI","byteString","split","indexOf","atob","decodeURI","mimeString","ia","Uint8Array","i","charCodeAt","Blob","type","getFileTransferData","options","result","client_id","env","license","defaultlicense","itemid","author","attr","repositories","repo_id","id","licenses","shortname","fileToSave","self","savepath","undefined","formData","FormData","xhr","XMLHttpRequest","append","sesskey","onreadystatechange","file","newhtml","readyState","status","JSON","parse","responseText","error","core","ajaxException","newfile","url","execCommand","send","getDialogue","focusAfterHide","hide","f","ctx","transferFromImageBitmap","toBlob"],"mappings":"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"}